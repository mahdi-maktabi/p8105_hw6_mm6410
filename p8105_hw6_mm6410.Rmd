---
title: "p8105_hw6_mm6410"
author: "Mahdi Maktabi"
date: "2024-12-01"
output: github_document
---

```{r, message=FALSE}
library(tidyverse)
library(modelr)
```

## Problem 1

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

```{r}
weather_df =
  weather_df |>
  bootstrap(5000) |> 
  mutate(
    models = map(strap, \(df) lm(tmax ~ tmin, data = df)),
    log_beta = map_dbl(models, ~ {
      coefs = broom::tidy(.x)
      log(coefs$estimate[1] * coefs$estimate[2])
    }),
    glance = map(models, broom::glance)
  )
```

### Plotting the R-Squared Distribution

```{r}
weather_df |> 
  select(strap, .id, glance) |> 
  unnest(glance) |> 
  select(.id, r.squared) |> 
  ggplot(aes(x = r.squared)) +
  geom_density()

weather_df |> 
  select(strap, .id, glance) |> 
  unnest(glance) |> 
  select(.id, r.squared) |> 
  pull(r.squared) |> 
  mean()
```

We can see from the density plot of the R-squared estimates that it is approximately normally distributed. The mean of the R-squared estimates is 0.911. 

### Plotting the log($\hat{\beta}_{0}$ * $\hat{\beta}_{1}$)

```{r}
weather_df |> 
  ggplot(aes(x = log_beta)) +
  geom_density()

weather_df |> 
  pull(log_beta) |> 
  mean()
```

Similarly, we can see from the density plot of the log($\hat{\beta}_{0}$ * $\hat{\beta}_{1}$) estimates that it is also approximately normally distributed with a mean of 2.013.

### Finding the 2.5% and 97.5% quantiles

```{r}
weather_df |> 
  select(strap, .id, glance) |> 
  unnest(glance) |> 
  select(.id, r.squared) |> 
  summarize(
    ci_low = quantile(r.squared, 0.025),
    ci_up = quantile(r.squared, 0.975)
  )

weather_df |> 
  summarize(
    ci_low = quantile(log_beta, 0.025),
    ci_up = quantile(log_beta, 0.975)
  )
```

The 95% CI for the r-squared and log of the estimated intercept * slope:

* r-squared: (0.894, 0.928)
* log($\hat{\beta}_{0}$ * $\hat{\beta}_{1}$): (1.97, 2.06)

## Problem 2

```{r}
homicide_df = read_csv(file = "./data/homicide-data.csv", na = c("NA", "", NA, "Unknown"))
```

```{r}
homicide_df =
  homicide_df |> 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    solved = if_else(disposition == "Closed by arrest", 1, 0),
    victim_age = as.numeric(victim_age)) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black")
  )
```

```{r}
baltimore_lm =
  homicide_df |> 
  filter(city_state == "Baltimore, MD") |> 
  glm(solved ~ victim_age + victim_sex + victim_race, data = _, family = binomial()) |> 
  broom::tidy(conf.int = TRUE) |> 
  mutate(
    adj_OR = exp(estimate),
    CI_low = exp(conf.low),
    CI_high = exp(conf.high)
  ) |> 
  filter(term == "victim_sexMale")
```

The estimated OR is 0.426 with a 95% CI (0.324, 0.558).

This means that the estimated odds of solving homicides for male victims is 0.426 times the odds of solving homicides for female victims, adjusting for age and race. A range of reasonable estimates for the true OR is between 0.324 and 0.558.

```{r}
all_city_lm =
  homicide_df |> 
    nest(data = -city_state) |> 
    mutate(
    models = map(data, \(df) glm(solved ~ victim_age + victim_sex + victim_race, data = df, family = binomial())),
    results = map(models, \(model) broom::tidy(model, conf.int = TRUE) |> 
                    mutate(
                      adj_OR = exp(estimate),
                      CI_low = exp(conf.low),
                      CI_high = exp(conf.high)
                    ) |> 
                    filter(term == "victim_sexMale"))) |> 
  select(city_state, results) |> 
  unnest(results) |> 
  select(city_state, adj_OR, CI_low, CI_high)
```

Now I will make a plot showing the estimate ORs and CIs for each city:

```{r}
all_city_lm |> 
  mutate(city_state = fct_reorder(city_state, adj_OR)) |> 
  ggplot(aes(x = city_state, y = adj_OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = CI_low, ymax = CI_high)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

This plot shows the estimated odds of solved homicides for male victims compared to female victims for each city, adjusting for age and race. The majority of the estimated ORs fall between the values of 0 to 1; but Atlanta GA, Richmond VA, Nashville TN, Fresno CA, Stockton CA, and Albuquerque NM all have estimated ORs greater than 1.

For the 95% CI, there are many cities that do not include the null value of 1 (generally the lower ORs). There are also many cities where the 95% CI have a very wide range and include the null value of 1. For these cities, the estimated OR that is seen might not be valid as this value could have been produced due to random chance. 

## Problem 3

```{r}
birthweight_df = 
  read_csv(file = "./data/birthweight.csv",
           na = c("NA", "", ".")) |> 
  janitor::clean_names() |> 
  mutate(
    babysex = factor(babysex, levels = c(1, 2), labels = c("Male", "Female")),
    frace = case_match(frace,
      1 ~ "White",
      2 ~ "Black",
      3 ~ "Asian",
      4 ~ "Puerto Rican",
      8 ~ "Other"),
    frace = fct_infreq(frace),
    mrace = case_match(mrace,
      1 ~ "White",
      2 ~ "Black",
      3 ~ "Asian",
      4 ~ "Puerto Rican",
      8 ~ "Other"),
    mrace = fct_infreq(mrace),
    malform = factor(malform, levels=c(0,1), labels=c("Absent", "Present"))
    )
```


